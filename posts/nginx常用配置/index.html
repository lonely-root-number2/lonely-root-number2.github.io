<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>nginx常用配置 | DY&#39;s blog</title>
    <meta property="og:title" content="nginx常用配置 - DY&#39;s blog">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-03-11T16:05:58&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-03-11T16:05:58&#43;08:00'>
        
    <meta name="Keywords" content="golang,java">
    <meta name="description" content="nginx常用配置">
        
    <meta name="author" content="DY">
    <meta property="og:url" content="http://4fan.top/posts/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://4fan.top">
                        DY&#39;s blog
                    </a>
                
                <p class="description">JAVA仔,Go语言爱好者</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://4fan.top">Home</a>
                    
                    <a  href="http://4fan.top/archives/" title="归档">归档</a>
                    
                    <a  href="http://4fan.top/reading/" title="阅读">阅读</a>
                    
                    <a  href="http://4fan.top/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">nginx常用配置</h1>
        </header>
        
  <time datetime="2021-03-11T16:05:58Z" class="post-meta meta-date dt-published">
    2021-03-11
  </time>



        
        
        <div class="post-content">
            <h2 id="控制以及常用命令">控制以及常用命令:</h2>
<pre tabindex="0"><code>1. 信号：
	http://nginx.org/en/docs/control.html
2. 命令
nginx -t #检查配置文件语法
nginx -c file #检查指定路径的配置文件语法
nginx -s reload #热重载，修改配置文件后使用
nginx -s stop #强制停止
nginx -s quit #优雅的停止
nginx -h #查看帮助
nginx -v  #版本
nginx -V  #查看编译参数
</code></pre><h2 id="http段">http段</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#nginx 的 default_server 指令可以定义默认的 server 出处理一些没有成功匹配 server_name 的请求，如果没有显式定义，则会选取第一个定义的 server 作为 default_server。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">server_name</span> <span style="color:#e6db74">z.com</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">root</span>  <span style="color:#e6db74">/home/html</span>;    <span style="color:#75715e">#通常用绝对路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#ae81ff">192</span><span style="color:#e6db74">.168.1.200</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">root</span>  <span style="color:#e6db74">/var/www/html</span>;    <span style="color:#75715e">#通常用绝对路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="日志管理">日志管理</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server中或者http中</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">eg:</span> <span style="color:#e6db74">记录在此位置的main类型日志</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#access_log  logs/access.log  main;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#                  &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#                  &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#注：通常在同目录下有error.log可供调试时查看
</span></span></span></code></pre></div><h2 id="location">location</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">分类：</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">精准匹配</span> = <span style="color:#e6db74">[优先]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">正则匹配</span> ~
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">普通匹配</span>  <span style="color:#e6db74">[匹配长的]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#demo1  index之坑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">location</span> =<span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">root</span>  <span style="color:#e6db74">/var/www/html</span>;    <span style="color:#75715e">#通常用绝对路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">index</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">root</span>  <span style="color:#e6db74">/usr/www/html</span>;    <span style="color:#75715e">#通常用绝对路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#访问 xxx/  ---&gt;精准匹配==&gt; xxx/index.htm ---&gt; /[普通匹配] --&gt; usr/www/html/index.htm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#总结：对于目录类型的匹配，index之后有一次内部重定向
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">！！</span><span style="color:#75715e"># location 匹配流程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">首先进行精准匹配，成功则返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">如果精准匹配不成功，对多条普通匹配进行验证并记录匹配长度最长的。</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">普通匹配成功后进行正则匹配，匹配成功则返回，如果不成功则返回普通匹配中匹配长度最长的。</span>
</span></span></code></pre></div><h2 id="rewrite-重写">rewrite 重写</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">if空格(条件){</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">set</span> <span style="color:#75715e">#设置变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">return</span> <span style="color:#75715e">#返回状态码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">break</span> <span style="color:#75715e">#跳出rewrite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">rewrite</span> <span style="color:#75715e">#重写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">条件：</span>
</span></span><span style="display:flex;"><span>	= <span style="color:#e6db74">判断相等</span>
</span></span><span style="display:flex;"><span>	~ <span style="color:#e6db74">正则匹配</span>
</span></span><span style="display:flex;"><span>	~<span style="color:#e6db74">*</span> <span style="color:#e6db74">不区分大小写的正则</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">-f,-d,-e</span> <span style="color:#e6db74">判断是否为文件，目录，存在</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">demo</span> <span style="color:#e6db74">封ip</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/test</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$remote_addr = <span style="color:#ae81ff">223</span><span style="color:#e6db74">.88.164.114)</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;
</span></span><span style="display:flex;"><span>            }   
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">demo</span> <span style="color:#e6db74">Edge重定向</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/test</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">root</span> <span style="color:#e6db74">/root/nngx</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">Edge)</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^.*</span>$ <span style="color:#e6db74">/test/ie.html</span> <span style="color:#e6db74">break</span>;   <span style="color:#75715e">#!!!===&gt;此处将 所有的URI替换，因此相当于无上下文，直接变成 /test/ie.html,另外 此处的break不能少，否则将出现循环重定向(500)。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">demo</span> <span style="color:#e6db74">set用法</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/test</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">if</span> <span style="color:#e6db74">(条件)</span>{
</span></span><span style="display:flex;"><span>            	<span style="color:#f92672">set</span> $site <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>       	<span style="color:#f92672">if</span> <span style="color:#e6db74">(条件2)</span>{
</span></span><span style="display:flex;"><span>            	<span style="color:#f92672">set</span> $site <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">if</span> <span style="color:#e6db74">(site</span> == <span style="color:#ae81ff">1</span><span style="color:#e6db74">)</span>{
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(!-e</span> $....<span style="color:#e6db74">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">demo</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">location</span> <span style="color:#e6db74">/ecshop</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">goods-(\d+)\.html</span> <span style="color:#e6db74">/ecshop/goods.php?id=</span>$1; <span style="color:#75715e">#正则后向引用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">....N</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">注意：url重写时，如果正则中有</span> {} <span style="color:#f92672">则必须加</span> <span style="color:#e6db74">&#34;&#34;</span>  
</span></span></code></pre></div><h2 id="root--alias--proxy_pass-的路径问题">root &amp;&amp; alias &amp;&amp; proxy_pass 的路径问题</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">【</span> <span style="color:#e6db74">root</span> <span style="color:#e6db74">】——根路径配置，用于访问文件系统，在匹配到location配置的URL路径后，指向【root】配置的路径，并把location配置路径附加到其后.</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/t/</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">root</span> <span style="color:#e6db74">/www/root/html/</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">如果一个请求的URI是/t/a.html时，web服务器将会返回服务器上的/www/root/html/t/a.html的文件。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">【</span> <span style="color:#e6db74">alias</span> <span style="color:#e6db74">】——别名配置，用于访问文件系统，在匹配到location配置的URL路径后，指向【alias】配置的路径。</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/t/</span> {
</span></span><span style="display:flex;"><span> <span style="color:#f92672">alias</span> <span style="color:#e6db74">/www/root/html/new_t/</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">如果一个请求的URI是/t/a.html时，web服务器将会返回服务器上的/www/root/html/new_t/a.html的文件。注意这里是new_t，因为alias会把location后面配置的路径丢弃掉，把当前匹配到的目录指向到指定的目录。</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">注意：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">使用alias时，目录名后面一定要加&#34;/&#34;且只能位于location块。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">【</span> <span style="color:#e6db74">proxy_pass</span> <span style="color:#e6db74">】</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">是否会附加location配置路径与【proxy_pass】配置的路径后是否有&#34;/&#34;有关，有&#34;/&#34;则不附加</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#例如 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/hello</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://localhost:5000/</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#asdsad/hello/haha----------&gt; 到后端的路由 /haha
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://localhost:5000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#asdsad/hello/haha----------&gt; 到后端的路由 /hello/haha
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="gzip">gzip</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">压缩类型：</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">gzip</span>  <span style="color:#e6db74">deflate</span>  <span style="color:#e6db74">compress</span> <span style="color:#e6db74">sdch[Google推出，支持较少]</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">context:</span> <span style="color:#e6db74">server,http,location</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">gzip</span> <span style="color:#66d9ef">on</span><span style="color:#e6db74">|off</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">gzip_buffers</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">4K</span>		<span style="color:#75715e">#[压缩在内存中缓冲多少再输出，32块4K]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_comp_level</span> <span style="color:#e6db74">[1-9]</span> <span style="color:#75715e">#通常取6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_min_length</span> <span style="color:#ae81ff">4000</span> <span style="color:#75715e">#低于此值的不压缩，4000字节起
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/css</span>  <span style="color:#75715e">#对哪些类型进行压缩  /etc/nginx/mime.types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_proxied</span>  <span style="color:#75715e">#如果请求者是代理服务器如何缓存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_disable</span> <span style="color:#75715e">#正则表达式，满足的URI不压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_vary</span> <span style="color:#66d9ef">on</span><span style="color:#e6db74">|off</span>  <span style="color:#75715e">#是否传输gzip压缩标志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span> <span style="color:#75715e">#满足版本的进行压缩，此选项意义不大
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#对于 图片/音乐 等资源文件压缩意义不大。比较小的文件压缩意义不大
</span></span></span></code></pre></div><h2 id="expires">expires</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#缓存 提高网站性能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">context:</span> <span style="color:#e6db74">server</span> <span style="color:#e6db74">location</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">expires</span> <span style="color:#e6db74">30s</span> <span style="color:#e6db74">/</span> <span style="color:#e6db74">m</span> <span style="color:#e6db74">h</span> <span style="color:#e6db74">d</span>             <span style="color:#75715e">#===&gt; 无304 not modified
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#缓存图片demo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">\.(jpg|jpeg|gif|png)</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expires</span> <span style="color:#e6db74">3d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">扩展：304原理：</span>  <span style="color:#e6db74">etag</span> <span style="color:#e6db74">[文件签名标签],</span> <span style="color:#e6db74">last_modified_since</span> <span style="color:#e6db74">协议头</span>
</span></span></code></pre></div><h2 id="负载均衡">负载均衡</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">Syntax:</span>	<span style="color:#e6db74">upstream</span> <span style="color:#e6db74">name</span> { <span style="color:#f92672">...</span> <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">Default:</span>	<span style="color:#e6db74">—</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">Context:</span>	<span style="color:#e6db74">http</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#demo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">http</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">upstream</span> <span style="color:#e6db74">myser</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> localhost:<span style="color:#ae81ff">1234</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> localhost:<span style="color:#ae81ff">1235</span>;
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://myser</span>;
</span></span><span style="display:flex;"><span>        }   
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">策略：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#e6db74">.</span> <span style="color:#e6db74">轮询[默认]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#e6db74">.</span> <span style="color:#e6db74">weight</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> localhost:<span style="color:#ae81ff">1234</span> <span style="color:#e6db74">weight=10</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#e6db74">.</span> <span style="color:#e6db74">iphash===&gt;解决session共享问题</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ip_hash</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> localhost:<span style="color:#ae81ff">1234</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">4.</span> <span style="color:#e6db74">fair(第三方)：按照响应时间分配，响应时间短的优先分配</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fair</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">第三方模块编译</span> <span style="color:#e6db74">--add-module=path</span>
</span></span></code></pre></div><h2 id="高性能服务器整体思路">高性能服务器整体思路</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">对于开发：</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">减少请求---&gt;合并CSS，背景图片，减少MySQL查询等</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">对于运维：</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">利用</span> <span style="color:#e6db74">expires</span> <span style="color:#e6db74">等使用浏览器缓存</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">其它：</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">CDN</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">对于最后不可避免的请求使用</span> <span style="color:#e6db74">集群</span> <span style="color:#e6db74">+</span> <span style="color:#e6db74">负载均衡解决</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">解决问题：</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">socket:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">nginx</span> :<span style="color:#e6db74">worker_connections</span> 
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">keepalive_timeout</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">system:</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">最大连接数：echo</span> <span style="color:#ae81ff">10000</span> <span style="color:#e6db74">&gt;</span> <span style="color:#e6db74">/proc/sys/net/core/somaxconn</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">加快tcp回收：echo</span> <span style="color:#ae81ff">1</span> <span style="color:#e6db74">&gt;</span> <span style="color:#e6db74">/proc/sys/net/ipv4/tcp_tw_recycle</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">空tcp重用：echo</span> <span style="color:#ae81ff">1</span> <span style="color:#e6db74">&gt;</span> <span style="color:#e6db74">/proc/sys/net/ipv4/tcp_tw_reuse</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">洪水攻击：echo</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&gt;/proc/sys/net/ipv4/tcp_syncookies</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">文件:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">nginx:</span> <span style="color:#e6db74">子进程允许打开文件数:</span>  <span style="color:#e6db74">worker_rlimit_nofile</span>  <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">系统:</span> <span style="color:#e6db74">ulimit</span> <span style="color:#e6db74">-n</span> <span style="color:#ae81ff">100000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#dmesg
</span></span></span></code></pre></div><h2 id="使用ab测压">使用ab测压</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#yum install httpd-tools
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ab</span> <span style="color:#e6db74">-c[并发]</span> <span style="color:#e6db74">-k[keep</span> <span style="color:#e6db74">alive]</span> <span style="color:#e6db74">-n[number]</span> 
</span></span></code></pre></div><h2 id="高可用">高可用</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">高可用：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">nginx宕机</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">keepalived,虚拟IP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">yum</span> <span style="color:#e6db74">install</span> <span style="color:#e6db74">keepalived</span> <span style="color:#e6db74">-y</span>
</span></span></code></pre></div>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>Author: </strong><a rel="author" href="http://4fan.top">DY</a></li>
        <li style="word-break:break-all"><strong>Link: </strong><a href="http://4fan.top/posts/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/">http://4fan.top/posts/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/</a></li>
        <li><strong>License: </strong>This work is under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>. Kindly fulfill the requirements of the aforementioned License when adapting or creating a derivative of this work.</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/posts/csapp%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81-ecf/">CSAPP读书笔记-8-异常控制流(ECF)</a></li>
        
        <li><a href="/posts/nodejs-tips/">nodejs tips</a></li>
        
        <li><a href="/posts/idea%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/">idea常用快捷键</a></li>
        
        <li><a href="/posts/wsl2%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/">wsl2折腾笔记</a></li>
        
        <li><a href="/posts/linux%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">linux定时任务</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/nginx' target="_blank">nginx</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2023 <a href="http://4fan.top">DY&#39;s blog By DY</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>





                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://4fan.top">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">Latest articles</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://4fan.top/posts/re-restart-in-hugo/" title="迁移到hugo" target="_blank">迁移到hugo</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/spring%E6%B3%A8%E8%A7%A3/" title="spring注解" target="_blank">spring注解</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/rust%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8/" title="rust生命周期标注" target="_blank">rust生命周期标注</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/go-mongodb%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AE%9E%E8%B7%B5/" title="go mongodb的一些实践" target="_blank">go mongodb的一些实践</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/go%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" title="go错误处理" target="_blank">go错误处理</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/drone-cicd%E5%AE%9E%E8%B7%B5/" title="drone cicd实践" target="_blank">drone cicd实践</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/2021%E5%B9%B4%E6%80%BB%E7%BB%93/" title="2021年总结" target="_blank">2021年总结</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" title="nginx常用配置" target="_blank">nginx常用配置</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/csapp%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81-ecf/" title="CSAPP读书笔记-8-异常控制流(ECF)" target="_blank">CSAPP读书笔记-8-异常控制流(ECF)</a>
    </li>
    
    <li>
        <a href="http://4fan.top/posts/nodejs-tips/" title="nodejs tips" target="_blank">nodejs tips</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>Categories</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>Tags</a></h3>
<div class="tagcloud">
    
    <a href="http://4fan.top/tags/cd/">cd</a>
    
    <a href="http://4fan.top/tags/ci/">ci</a>
    
    <a href="http://4fan.top/tags/cron/">cron</a>
    
    <a href="http://4fan.top/tags/csapp/">csapp</a>
    
    <a href="http://4fan.top/tags/docker/">docker</a>
    
    <a href="http://4fan.top/tags/drone/">drone</a>
    
    <a href="http://4fan.top/tags/ecf/">ECF</a>
    
    <a href="http://4fan.top/tags/github/">Github</a>
    
    <a href="http://4fan.top/tags/go/">go</a>
    
    <a href="http://4fan.top/tags/hugo/">hugo</a>
    
    <a href="http://4fan.top/tags/ide/">ide</a>
    
    <a href="http://4fan.top/tags/idea/">idea</a>
    
    <a href="http://4fan.top/tags/java/">java</a>
    
    <a href="http://4fan.top/tags/jwt/">jwt</a>
    
    <a href="http://4fan.top/tags/linux/">linux</a>
    
    <a href="http://4fan.top/tags/nginx/">nginx</a>
    
    <a href="http://4fan.top/tags/nodejs/">nodejs</a>
    
    <a href="http://4fan.top/tags/rust/">rust</a>
    
    <a href="http://4fan.top/tags/shell/">shell</a>
    
    <a href="http://4fan.top/tags/spring/">spring</a>
    
    <a href="http://4fan.top/tags/spring-boot/">spring boot</a>
    
    <a href="http://4fan.top/tags/vscode/">vscode</a>
    
    <a href="http://4fan.top/tags/web/">web</a>
    
    <a href="http://4fan.top/tags/wsl2/">wsl2</a>
    
    <a href="http://4fan.top/tags/%E5%85%A5%E9%97%A8/">入门</a>
    
    <a href="http://4fan.top/tags/%E5%89%8D%E7%AB%AF/">前端</a>
    
    <a href="http://4fan.top/tags/%E5%B0%8F%E5%B9%B4/">小年</a>
    
    <a href="http://4fan.top/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">年终总结</a>
    
    <a href="http://4fan.top/tags/%E5%B9%B6%E5%8F%91/">并发</a>
    
    <a href="http://4fan.top/tags/%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/">异常控制流</a>
    
    <a href="http://4fan.top/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
    
    <a href="http://4fan.top/tags/%E6%80%BB%E7%BB%93/">总结</a>
    
    <a href="http://4fan.top/tags/%E6%8F%92%E4%BB%B6/">插件</a>
    
    <a href="http://4fan.top/tags/%E6%90%AD%E5%BB%BA/">搭建</a>
    
    <a href="http://4fan.top/tags/%E6%9D%82%E8%B0%88/">杂谈</a>
    
    <a href="http://4fan.top/tags/%E6%B3%A8%E8%A7%A3/">注解</a>
    
    <a href="http://4fan.top/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/">深入理解计算机系统</a>
    
    <a href="http://4fan.top/tags/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">生命周期</a>
    
    <a href="http://4fan.top/tags/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8/">生命周期标注</a>
    
    <a href="http://4fan.top/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/">错误处理</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">Links</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://blog.semesse.me/" title="色魔是色魔">semesse</a>
        </li>
        
        <li>
            <a target="_blank" href="http://iww915.top" title="iww915">iww915</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">Meta</h3>
        <ul class="widget-list">
            <li><a href="http://4fan.top/index.xml">RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>